name: Deploy to UAT (GCP)

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-south1
  SERVICE_NAME: lumen-uat-service
  # Repository paths provided by you
  FASTAPI_IMAGE: asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/fastapi-lumen-uat/fastapi-lumen-uat:lumen-uat-${{ github.sha }}
  NGINX_IMAGE: asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/nginx-lumen-uat/nginx-lumen-uat:lumen-uat-${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: uat

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Authenticate to Google Cloud
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2. Configure Docker
      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Build and Push FastAPI Image
      - name: Build and push FastAPI image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/uat/Dockerfile.fastapi
          platforms: linux/x86_64
          push: true
          tags: ${{ env.FASTAPI_IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 4. Build and Push Nginx Image
      - name: Build and push Nginx image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/uat/Dockerfile.nginx
          platforms: linux/x86_64
          push: true
          tags: ${{ env.NGINX_IMAGE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. Generate Cloud Run Service YAML (Injecting Secrets directly)
      - name: Create Cloud Run Service YAML
        run: |
          cat > service.yaml <<EOF
          apiVersion: serving.knative.dev/v1
          kind: Service
          metadata:
            name: ${{ env.SERVICE_NAME }}
            labels:
              cloud.googleapis.com/location: ${{ env.REGION }}
            annotations:
              run.googleapis.com/launch-stage: BETA
          spec:
            template:
              metadata:
                annotations:
                  run.googleapis.com/execution-environment: gen2
                  autoscaling.knative.dev/minScale: "1"
                  run.googleapis.com/startup-cpu-boost: "true"
                  # Dependency ensures Nginx waits for FastAPI health check
                  run.googleapis.com/container-dependencies: '{"nginx":["fastapi"]}'
              spec:
                serviceAccountName: 929981480750-compute@developer.gserviceaccount.com
                containers:
                  # --- CONTAINER 1: NGINX ---
                  - name: nginx
                    image: ${{ env.NGINX_IMAGE }}
                    ports:
                      - containerPort: 80
                    resources:
                      limits:
                        memory: 512Mi
                        cpu: "500m"
                    readinessProbe:
                      httpGet:
                        path: /
                        port: 80

                  # --- CONTAINER 2: FASTAPI ---
                  - name: fastapi
                    image: ${{ env.FASTAPI_IMAGE }}
                    resources:
                      limits:
                        memory: 8Gi
                        cpu: "4"
                    env:
                      - name: PORT
                        value: "8000"
                      - name: ENV
                        value: "dev"
                      - name: DATABASE_URL
                        value: "${{ secrets.DATABASE_URL }}"
                      - name: ANTHROPIC_CLIENT_KEY
                        value: "${{ secrets.ANTHROPIC_CLIENT_KEY }}"
                      - name: NEUFIN_BACKEND_S3_BUCKET
                        value: "${{ secrets.NEUFIN_BACKEND_S3_BUCKET }}"
                      - name: NEUFIN_BACKEND_S3_SECRET_ACCESS_KEY
                        value: "${{ secrets.NEUFIN_BACKEND_S3_SECRET_ACCESS_KEY }}"
                      - name: NEUFIN_BACKEND_S3_REGION
                        value: "${{ secrets.NEUFIN_BACKEND_S3_REGION }}"
                      - name: NEUFIN_BACKEND_S3_ACCESS_KEY_ID
                        value: "${{ secrets.NEUFIN_BACKEND_S3_ACCESS_KEY_ID }}"
                      - name: SLACK_BOT_TOKEN
                        value: "${{ secrets.SLACK_BOT_TOKEN }}"
                      - name: SLACK_ALERT_CHANNEL
                        value: "${{ secrets.SLACK_ALERT_CHANNEL }}"
                      - name: API_KEY
                        value: "${{ secrets.API_KEY }}"
                      - name: CLERK_WEBHOOK_SIGNING_SECRET
                        value: "${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}"
                      - name: CLERK_SECRET_KEY
                        value: "${{ secrets.CLERK_SECRET_KEY }}"
                      - name: SECRET_KEY
                        value: "${{ secrets.SECRET_KEY }}"
                      - name: RAZORPAY_AUTH_TOKEN
                        value: "${{ secrets.RAZORPAY_AUTH_TOKEN }}"
                      - name: ELMEASURE_URL
                        value: "${{ secrets.ELMEASURE_URL }}"
                      - name: RAZORPAY_VA_CREDITED_WEBHOOK_SECRET
                        value: "${{ secrets.RAZORPAY_VA_CREDITED_WEBHOOK_SECRET }}"
                    
                    # PROBES for Reliability
                    startupProbe:
                      httpGet:
                        path: /healthz
                        port: 8000
                      initialDelaySeconds: 10
                      periodSeconds: 5
                      failureThreshold: 15
                    readinessProbe:
                      httpGet:
                        path: /healthz
                        port: 8000
                    livenessProbe:
                      httpGet:
                        path: /healthz
                        port: 8000
                      periodSeconds: 20
          EOF

      # 6. Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace service.yaml --region ${{ env.REGION }}
      
      # 7. Verify
      - name: Verify Service Status
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')
          echo "Deployment Complete!"
          echo "URL: $SERVICE_URL"
